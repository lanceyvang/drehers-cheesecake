---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Shopping Cart">
  <section class="pt-32 pb-8 bg-gradient-to-b from-cream to-cream-light">
    <div class="container">
      <h1 class="font-display text-4xl md:text-5xl font-bold text-chocolate text-center">
        Your Cart
      </h1>
    </div>
  </section>
  
  <section class="py-12 bg-cream-light min-h-[60vh]">
    <div class="container">
      <div id="cart-container" class="max-w-4xl mx-auto">
        <!-- Cart will be rendered by JavaScript -->
        <div id="cart-loading" class="text-center py-16">
          <div class="spinner mx-auto mb-4"></div>
          <p class="text-slate">Loading your cart...</p>
        </div>
        
        <div id="cart-empty" class="text-center py-16 hidden">
          <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-cream flex items-center justify-center">
            <svg class="w-12 h-12 text-slate" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
            </svg>
          </div>
          <h2 class="font-display text-2xl font-semibold text-chocolate mb-2">Your cart is empty</h2>
          <p class="text-slate mb-6">Looks like you haven't added any items yet.</p>
          <a href="/products" class="btn btn-primary">Start Shopping</a>
        </div>
        
        <div id="cart-content" class="hidden">
          <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
            <!-- Cart Items -->
            <div id="cart-items" class="divide-y divide-cream-dark">
              <!-- Items rendered by JS -->
            </div>
          </div>
          
          <!-- Cart Summary -->
          <div class="mt-8 bg-white rounded-2xl shadow-sm p-6">
            <h3 class="font-display text-xl font-semibold text-chocolate mb-4">Order Summary</h3>
            
            <div class="space-y-3 mb-6">
              <div class="flex justify-between text-slate">
                <span>Subtotal</span>
                <span id="cart-subtotal">$0.00</span>
              </div>
              <div class="flex justify-between text-slate">
                <span>Delivery</span>
                <span class="text-green-600">Free</span>
              </div>
              <div class="border-t border-cream-dark pt-3 flex justify-between font-semibold text-chocolate">
                <span>Total</span>
                <span id="cart-total" class="text-xl">$0.00</span>
              </div>
            </div>
            
            <!-- Deposit Notice -->
            <div id="deposit-notice" class="hidden mb-6 p-4 bg-gold/10 rounded-lg border border-gold/30">
              <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-gold-dark flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                  <p class="font-semibold text-chocolate text-sm">Custom Cake Deposit Required</p>
                  <p class="text-sm text-slate mt-1">
                    Your order includes custom cakes which require a 50% deposit. 
                    Deposit amount: <span id="deposit-amount" class="font-semibold text-gold-dark">$0.00</span>
                  </p>
                </div>
              </div>
            </div>
            
            <a href="/checkout" class="btn btn-primary w-full">
              Proceed to Checkout
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
            
            <p class="text-center text-sm text-slate mt-4">
              Secure checkout with Stripe & PayPal
            </p>
          </div>
          
          <!-- Continue Shopping -->
          <div class="text-center mt-8">
            <a href="/products" class="text-gold-dark hover:text-berry transition-colors font-medium">
              &larr; Continue Shopping
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  interface CartItem {
    id: string;
    name: string;
    price: number;
    image?: string;
    quantity: number;
    isCustomCake?: boolean;
  }

  function formatPrice(amount: number): string {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(amount);
  }

  function renderCart() {
    const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');
    
    const loadingEl = document.getElementById('cart-loading');
    const emptyEl = document.getElementById('cart-empty');
    const contentEl = document.getElementById('cart-content');
    const itemsEl = document.getElementById('cart-items');
    
    if (loadingEl) loadingEl.classList.add('hidden');
    
    if (cart.length === 0) {
      if (emptyEl) emptyEl.classList.remove('hidden');
      if (contentEl) contentEl.classList.add('hidden');
      return;
    }
    
    if (emptyEl) emptyEl.classList.add('hidden');
    if (contentEl) contentEl.classList.remove('hidden');
    
    // Render cart items
    if (itemsEl) {
      itemsEl.innerHTML = cart.map(item => `
        <div class="p-6 flex gap-4" data-item-id="${item.id}">
          <div class="w-24 h-24 rounded-lg overflow-hidden flex-shrink-0 bg-cream">
            ${item.image 
              ? `<img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover" />`
              : `<div class="w-full h-full flex items-center justify-center text-3xl">üç∞</div>`
            }
          </div>
          <div class="flex-1 min-w-0">
            <h4 class="font-display font-semibold text-chocolate truncate">${item.name}</h4>
            <p class="text-gold-dark font-semibold mt-1">${formatPrice(item.price)}</p>
            
            <div class="flex items-center gap-4 mt-3">
              <div class="flex items-center border border-cream-dark rounded-lg">
                <button 
                  class="quantity-btn w-8 h-8 flex items-center justify-center text-slate hover:text-chocolate transition-colors"
                  data-action="decrease"
                  data-item-id="${item.id}"
                >
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
                  </svg>
                </button>
                <span class="w-10 text-center font-medium text-chocolate">${item.quantity}</span>
                <button 
                  class="quantity-btn w-8 h-8 flex items-center justify-center text-slate hover:text-chocolate transition-colors"
                  data-action="increase"
                  data-item-id="${item.id}"
                >
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                  </svg>
                </button>
              </div>
              
              <button 
                class="remove-btn text-sm text-berry hover:text-strawberry transition-colors"
                data-item-id="${item.id}"
              >
                Remove
              </button>
            </div>
          </div>
          <div class="text-right">
            <p class="font-display font-semibold text-chocolate">
              ${formatPrice(item.price * item.quantity)}
            </p>
          </div>
        </div>
      `).join('');
    }
    
    // Calculate totals
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    // Check for custom cakes (price >= 150 typically indicates custom cake)
    const hasCustomCakes = cart.some(item => item.price >= 150);
    const customCakeTotal = cart
      .filter(item => item.price >= 150)
      .reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const depositAmount = customCakeTotal * 0.5;
    
    // Update UI
    const subtotalEl = document.getElementById('cart-subtotal');
    const totalEl = document.getElementById('cart-total');
    const depositNotice = document.getElementById('deposit-notice');
    const depositAmountEl = document.getElementById('deposit-amount');
    
    if (subtotalEl) subtotalEl.textContent = formatPrice(subtotal);
    if (totalEl) totalEl.textContent = formatPrice(subtotal);
    
    if (hasCustomCakes && depositNotice && depositAmountEl) {
      depositNotice.classList.remove('hidden');
      depositAmountEl.textContent = formatPrice(depositAmount);
    } else if (depositNotice) {
      depositNotice.classList.add('hidden');
    }
    
    // Add event listeners
    document.querySelectorAll('.quantity-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const action = button.dataset.action;
        const itemId = button.dataset.itemId;
        updateQuantity(itemId!, action === 'increase' ? 1 : -1);
      });
    });
    
    document.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const itemId = button.dataset.itemId;
        removeItem(itemId!);
      });
    });
  }

  function updateQuantity(itemId: string, delta: number) {
    const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');
    const index = cart.findIndex(item => item.id === itemId);
    
    if (index > -1) {
      cart[index].quantity += delta;
      if (cart[index].quantity <= 0) {
        cart.splice(index, 1);
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      window.dispatchEvent(new CustomEvent('cart-updated'));
      renderCart();
    }
  }

  function removeItem(itemId: string) {
    const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');
    const filtered = cart.filter(item => item.id !== itemId);
    localStorage.setItem('cart', JSON.stringify(filtered));
    window.dispatchEvent(new CustomEvent('cart-updated'));
    renderCart();
  }

  // Initial render
  renderCart();
</script>
